<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.eemp.modules.edu.statistics.mapper.EduInformatizationBasicInfo_1Mapper">

    <!-- 查找最新的年度记录 -->
    <select id="findNewestYearlyRecord" resultType="java.util.HashMap">
        <if test="dbType == 'mysql'">
            select a.*
            from
              edu_informatization_basic_info_1 a
              join
              ( select identification_code, date_format(fill_date, '%Y') as year, max(fill_date) maxdate
                from `edu_informatization_basic_info_1`
                where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
                group by identification_code, year ) b
              on a.identification_code = b.identification_code and a.fill_date = b.maxdate
        </if>
        <if test="dbType == 'h2'">
            select a.*
            from
              edu_informatization_basic_info_1 a
              join
              ( select identification_code, to_char(fill_date, 'yyyy') as year, max(fill_date) maxdate
                from `edu_informatization_basic_info_1`
                where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
                group by identification_code, year ) b
              on a.identification_code = b.identification_code and a.fill_date = b.maxdate
        </if>
    </select>

    <!-- 查找最新的学期记录 -->
    <select id="findNewestSemesterlyRecord" resultType="java.util.HashMap">
        <if test="dbType == 'mysql'">
            select concat(year, half) as semester, a.*
            from
                edu_informatization_basic_info_1 a
                join
                ( select
                        identification_code,
                        date_format(fill_date, '%Y') as year,
                        if(date_format(fill_date, '%m') >= 7, '下半年', '上半年') as half,
                        max(fill_date) maxdate
                    from `edu_informatization_basic_info_1`
                    where fill_date >= #{dayStart} and fill_date &lt; #{dayEnd}
                    group by identification_code, year, half ) b
                on a.identification_code = b.identification_code and a.fill_date = b.maxdate
        </if>
        <if test="dbType == 'h2'">
            select concat(year, half) as semester, a.*
            from
                edu_informatization_basic_info_1 a
                join
                ( select
                        identification_code,
                        to_char(fill_date, 'yyyy') as year,
                        case when to_char(fill_date, 'MM') >= 7 then '下半年' else '上半年' end as half,
                        max(fill_date) maxdate
                    from `edu_informatization_basic_info_1`
                    where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
                    group by identification_code, year, half ) b
                on a.identification_code = b.identification_code and a.fill_date = b.maxdate
        </if>
    </select>

    <!-- 获取教师人数统计 -->
    <select id="getTeacherNumberInfo" resultType="java.util.HashMap">
        <if test="dbType == 'mysql'">
            select chart_group, concat(year, half) as type, sum(teacher_count) as value
            from
                ( edu_informatization_basic_info_1 a
                join
                ( select
                        identification_code,
                        date_format(fill_date, '%Y') as year,
                        if(date_format(fill_date, '%m') >= 7, '下半年', '上半年') as half,
                        max(fill_date) maxdate
                    from edu_informatization_basic_info_1
                    where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
                    group by identification_code, year, half ) b
                join
                ( select
                        identification_code,
                        chart_group
                    from organization_definition ) c
                on a.identification_code = b.identification_code and a.fill_date = b.maxdate
                    and a.identification_code = c.identification_code )
            group by chart_group, year, half
        </if>
        <if test="dbType == 'h2'">
            select chart_group, concat(year, half) as type, sum(teacher_count) as value
            from
                ( edu_informatization_basic_info_1 a
                join
                ( select
                        identification_code,
                        to_char(fill_date, 'yyyy') as year,
                        case when to_char(fill_date, 'MM') >= 7 then '下半年' else '上半年' end as half,
                        max(fill_date) maxdate
                    from edu_informatization_basic_info_1
                    where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
                    group by identification_code, year, half ) b
                join
                ( select
                        identification_code,
                        chart_group
                    from organization_definition ) c
                on a.identification_code = b.identification_code and a.fill_date = b.maxdate
                    and a.identification_code = c.identification_code )
            group by chart_group, year, half
        </if>
    </select>

    <!-- 获取学生人数统计 -->
    <select id="getStudentNumberInfo" resultType="java.util.HashMap">
        <if test="dbType == 'mysql'">
            select chart_group, concat(year, half) as type, sum(student_count) as value
            from
            ( edu_informatization_basic_info_1 a
            join
            ( select
            identification_code,
            date_format(fill_date, '%Y') as year,
            if(date_format(fill_date, '%m') >= 7, '下半年', '上半年') as half,
            max(fill_date) maxdate
            from edu_informatization_basic_info_1
            where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
            group by identification_code, year, half ) b
            join
            ( select
            identification_code,
            chart_group
            from organization_definition ) c
            on a.identification_code = b.identification_code and a.fill_date = b.maxdate
            and a.identification_code = c.identification_code )
            group by chart_group, year, half
        </if>
        <if test="dbType == 'h2'">
            select chart_group, concat(year, half) as type, sum(student_count) as value
            from
            ( edu_informatization_basic_info_1 a
            join
            ( select
            identification_code,
            to_char(fill_date, 'yyyy') as year,
            case when to_char(fill_date, 'MM') >= 7 then '下半年' else '上半年' end as half,
            max(fill_date) maxdate
            from edu_informatization_basic_info_1
            where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
            group by identification_code, year, half ) b
            join
            ( select
            identification_code,
            chart_group
            from organization_definition ) c
            on a.identification_code = b.identification_code and a.fill_date = b.maxdate
            and a.identification_code = c.identification_code )
            group by chart_group, year, half
        </if>
    </select>

    <!-- 获取中心机房建设情况 -->
    <select id="getCentralRoomInfo" resultType="java.util.HashMap">
        <if test="dbType == 'mysql'">
            select name, sum(num) value
            from
              ( select identification_code, fill_date, '已建中心机房' name, 1 num
                from edu_informatization_basic_info_1
                where has_a_central_server_room = 1
                union
                select identification_code, fill_date, '未建中心机房' name, 1 num
                from edu_informatization_basic_info_1
                where has_a_central_server_room = 0 ) a
              join
              ( select identification_code, max(fill_date) maxdate
                from edu_informatization_basic_info_1
                group by identification_code ) b
              on a.identification_code = b.identification_code and a.fill_date = b.maxdate
            group by name
        </if>
    </select>

    <!-- 获取教师人数统计（按学校类型维度） -->
    <select id="getTeacherNumberInfoBySchoolType" resultType="java.util.HashMap">
        <if test="dbType == 'mysql'">
            select chart_group, concat(year, half) as type, sum(teacher_count) as value
            from
              ( edu_informatization_basic_info_1 a
                join
                ( select
                    identification_code,
                    date_format(fill_date, '%Y') as year,
                    if(date_format(fill_date, '%m') >= 7, '下半年', '上半年') as half,
                    max(fill_date) maxdate
                  from edu_informatization_basic_info_1
                  where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
                  group by identification_code, year, half ) b
                join
                ( select
                    identification_code,
                    institution_type
                  from organization_definition ) c
                join
                ( select
                    item_text chart_group,
                    item_value
                  from sys_dict_item
                  where dict_id in (select id from sys_dict where dict_code = 'institution_type')) d
                on a.identification_code = b.identification_code and a.fill_date = b.maxdate
                  and a.identification_code = c.identification_code
                  and c.institution_type = d.item_value )
            group by chart_group, year, half
        </if>
    </select>

    <!-- 获取学生人数统计 -->
    <select id="getStudentNumberInfoBySchoolType" resultType="java.util.HashMap">
        <if test="dbType == 'mysql'">
            select chart_group, concat(year, half) as type, sum(student_count) as value
            from
              ( edu_informatization_basic_info_1 a
                join
                ( select
                    identification_code,
                    date_format(fill_date, '%Y') as year,
                    if(date_format(fill_date, '%m') >= 7, '下半年', '上半年') as half,
                    max(fill_date) maxdate
                  from edu_informatization_basic_info_1
                  where fill_date &gt;= #{dayStart} and fill_date &lt; #{dayEnd}
                  group by identification_code, year, half ) b
                join
                ( select
                    identification_code,
                    institution_type
                  from organization_definition ) c
                join
                ( select
                    item_text chart_group,
                    item_value
                  from sys_dict_item
                  where dict_id in (select id from sys_dict where dict_code = 'institution_type')) d
                on a.identification_code = b.identification_code and a.fill_date = b.maxdate
                  and a.identification_code = c.identification_code
                  and c.institution_type = d.item_value )
            group by chart_group, year, half
        </if>
    </select>

</mapper>